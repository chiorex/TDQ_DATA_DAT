---
layout: default
title: コマンドの道具や装備で仲間の名前が消える
update: 2024-03-02
---

>
__データはXDF版（1999/11/10版DRAGON.X）のものであり、最新バグフィックス版ではここに記載の数値では期待動作をしません。__

![どうぐ](https://gist.github.com/assets/22233327/ec376742-1e0b-4865-8a3a-052d488de3a4)
![そうび](https://gist.github.com/assets/22233327/574631fd-fc8b-4de0-a10e-fc82d9315684)

コマンドの __どうぐ__ や __そうび__ で仲間の名前が消えるバグの活用例

* 移動中コマンド-道具
* 移動中コマンド-装備
* 店での売買
* 預かり所
* 魔物の宝箱を開けたとき持ち物が一杯でアイテムを捨てるとき
* ルイーダでのアイテム交換

このバグは ~~闇が深い~~ 奥が深い。

## 目次

* バグ発生パターン
	* リッチのメガンテ型
	* 主人公消失型
* 活用例
	* ベホマンの装備を変更する（難易度★）
	* ゴーレムにアイテムを持たせる（難易度★）
	* アイテム増殖（難易度★★）
	* 序盤にアラキの法衣を手に入れる（難易度★★★）
	* 序盤に雷雲の杖を手に入れる（難易度★★★★）
* ホークマンバグ
	* 仕組み
	* バグキャラのアイテムを手に入れる（難易度★★★★★）
	* 魔物の宝を変更する（難易度★★★★★★★★）
	* 預かり所に任意のコードを格納（難易度★★★★★★★★★★★★）

## バグ発生パターン

### リッチのメガンテ型

[リッチのメガンテバグ](bug002.md)を参照

* 最も有名なパターン
* 主人公がパーティから外れないのが利点
* 利用可能な時期が終盤になるので実用性は若干下がる

### 主人公消失型

主人公を消してアイテムを渡せないメンバーだけのパーティを作る

* 早い段階で利用できるので実用性が高い
* 主人公消失による弊害が大きい

#### バシルーラでキャラが消失するバグを利用

[バシルーラバグ](bug004.md)で主人公を消す

* 終盤なら簡単に再現できる
	* 序盤にも出来るが手間が掛かる
* 既存のセーブデータでとりあえず試してみるには適した方法

#### ノーセーブクリアバグを利用

ルイーダで主人公と別れる（主人公と別れずにルイーダのアイテム交換のみを利用する手もある）

* 本格的に使う場合に適した方法
* ノーセーブ削除を使った亜種なら序盤から簡単に利用できる
* ⇒[ノーセーブクリアバグ](bug003.md)

#### 預かり所のオーバーランを利用

PT人数書き換えで主人公をパーティから消す（アラキ・主人公・ミシーナ⇒アラキなど）

* 手間が掛かる上にチャンスが一度しかないので主人公消失目的としては使いづらい
* 主人公消失が早すぎるのですぐにシナリオが進まなくなり嵌る
* ⇒[預かり所のオーバーラン](bug001.md)


## 活用例

難易度が高くなるほどTDQ2のメモリレイアウトとX68に関する知識がより多く必要になる。
ところどころにC言語やM68Kアセンブリ言語風のごちゃまぜ記法がありますが、フィーリングで読み進めてください。

### ベホマンの装備を変更する（難易度★）

<video width="320" height="240" controls poster="https://gist.github.com/assets/22233327/8c4518d4-f2a3-4a47-85ce-e0e6590208d7"><source src="https://gist.github.com/assets/22233327/71fbae87-53cf-4d6c-9210-22e9b466946c" type="video/mp4"></video>

### ゴーレムにアイテムを持たせる（難易度★）

<video width="320" height="240" controls poster="https://gist.github.com/assets/22233327/61c25ee9-9333-430a-b4d8-7b9bf53411b0"><source src="https://gist.github.com/assets/22233327/1bca507c-b9dd-4bc2-843a-7e4b511621b9" type="video/mp4"></video>

#### メモ

* ルイーダのアイテム交換を利用するとゴーレムがリストから消える

### アイテム増殖（難易度★★）

* 手軽に出来る割に実用性が高い
* サンチュが同行している間に可能
* サンチュと別れた後はパーティ入れ替え、ホンニンの加入、ルイーダのアイテム交換を利用するとできなくなることが多い

#### パーティ隊列

チオレ・トーイ・モーニ・サンチュのパーティの場合

| アドレス                     | No | データ | 説明                 |
|:-----------------------------|:--:|:------:|:---------------------|
| __PC隊列[5].b__ の先頭       |  0 | $10    | チオレ               |
|                              |  1 | $04    | トーイ               |
|                              |  2 | $05    | モーニ               |
|                              |  3 | ?      | （不定）             |
|                              |  4 | ?      | （不定）             |
| -                            |  5 | ?      | （不定）             |
| __NPC含む隊列[32].w__ の先頭 |  6 | $00    | チオレ               |
|                              |  7 | $10    | チオレ               |
|                              |  8 | $00    | トーイ               |
|                              |  9 | $04    | トーイ               |
|                              | 10 | $00    | モーニ               |
|                              | 11 | $05    | モーニ               |
|                              | 12 | $26    | サンチュPCG番号      |
|                              | 13 | $0e    | サンチュパレット番号 |

#### 手順

1. アイテム増殖前にセーブ
1. 増やしたいアイテムを __PC隊列[12]__ （サンチュPCG番号）に渡す（ヴに渡したと出る）
1. セーブせずに __さくせん⇒ぼうけんをおわる__
	* X68リセットではダメ
1. さっきの冒険の書をロード
1. __PC隊列[12]__ がさっき渡したアイテムを持っているので取り戻す

#### メモ

* $26をキャラIDと誤認識し範囲外アドレスにアイテムを格納している
	* ここは危険のないアドレスなので比較的自由に使える
* 工夫すれば別の冒険の書にアイテムを渡すことも出来る

<video width="320" height="240" controls poster="https://gist.github.com/assets/22233327/4f7ee09b-60c9-418c-a41b-1153bdcc9cce"><source src="https://gist.github.com/assets/22233327/3756e3a2-75c8-48ff-a5e5-fd4de43e40a9" type="video/mp4"></video>
<video width="320" height="240" controls poster="https://gist.github.com/assets/22233327/98f55b3e-d6c4-4773-b5a5-65e432f2063d"><source src="https://gist.github.com/assets/22233327/5ad07e4e-f309-41f0-bc5b-da77e9a7b537" type="video/mp4"></video>

### 序盤にアラキの法衣を手に入れる（難易度★★★）

* アラキ(NPC)を隊列最後尾にしてから別れる
* ルイーダ開放後にチオレ一人PTにしてアイテムを交換
	* ノーセーブクリアバグなら主人公と別れずにルイーダのアイテム交換も可能（アウカクとヤンをルイーダに登録する前）
	* 方法によってヤンをルイーダに登録すべきタイミングが変わる
	* チオレは装備できないので預かり所に預けるのが良い
	* 工夫すればミシーナにアラキの法衣を装備させることも可能

<video width="320" height="240" controls poster=""><source src="https://gist.github.com/assets/22233327/2f1aa9ce-6722-48a8-872c-eb9b7df24fae" type="video/mp4"></video>

### 序盤に雷雲の杖を手に入れる（難易度★★★★）

* [コールバック放置バグ](bug000.md)で雷雲の杖を2本以上手に入れる
* シャウク(NPC)を隊列最後尾にしてから別れる
* [預かり所のオーバーラン](bug001.md)でミシーナと別れるときにチオレを加入させない
	* アラキ加入時に二人PTにしないと隊列３番目にいたシャウク(NPC)の隊列Noが上書きされて消えてしまうため
* あとはアラキの法衣を手に入れる方法と同様
* シャウクは武術大会後に復帰するのでこのタイミングでの入手は手間の割に利点が少ない

TODO スクリーンショット

---

## ホークマンバグ

>
__データはXDF版（1999/11/10版DRAGON.X）のものであり、最新バグフィックス版ではここに記載の数値では期待動作をしません。__

パーティ隊列の一つ上のバグキャラ __（PC隊列[-1]）__ にカーソルを合わせたときに発生するバグ

* AI学習状態で現象が変わる
* __非常に危険なバグ__ 
	* AI学習状態によっては __PC隊列[-1]__ にカーソルを合わせた時点でフリーズする
	* 正常に見えてもシステムがどこかしら壊れているので、用が済んだらすぐにリセットした方が良い
	* __さくせん⇒ぼうけんをおわる⇒DOSにもどる__ は、やめたほうがいい
	* X68実機で試すのは、やめたほうがいい

### 仕組み

* __PC隊列[-1]__ が __PC隊列[255]__ を参照している
	* 実際には隊列データではなくAIのホークマン学習状態2バイト目が格納されている
* __PC隊列[255]__ のデータをキャラIDと誤認識して所持品アドレスを算出する
	* 1キャラ104バイトの構造体
* 参照アドレスが安全でも __PC隊列[-1]__ にカーソルを合わせた時点でシステムがどこかしら壊れているので注意

### バグキャラのアイテムを手に入れる（難易度★★★★★）

![預かり所経由](https://gist.github.com/assets/22233327/7a1721ad-8945-498f-be1d-33e01df49e89)

__PC隊列[-1]__ からパーティキャラへ道具を渡すときは __コマンド⇒どうぐ__ を使わず預かり所経由で受け渡しを行う

* __コマンド⇒どうぐ__ を使うとセーブ時や街へ入るときにフリーズしてしまう
	* ディスクアクセス周りのプログラムが壊れているため
	* __コマンド⇒どうぐ__ 以外だと別の箇所が壊れるがディスクアクセス周りは無事なのでセーブや街の移動が出来る
* パーティキャラから __PC隊列[-1]__ へ道具を渡すときは __コマンド⇒どうぐ__ を使っても良い
* 変則的なケースでは、魔物の宝箱を開けたとき持ち物が一杯でアイテムを捨てる方法も使いどころがある

### 魔物の宝を変更する（難易度★★★★★★★★）

![ドロップ変更](https://gist.github.com/assets/22233327/f73f55f4-c510-47c7-b3a2-c6dc405cfd62)

#### ホークマン学習状態

フタバ竜の宝のアドレスにアクセス

* __PC隊列[255]__ を __バグキャラ[$74]__ にセット

| データ | ホ | マ | ザ | ヒ | バ | イ | ギ | メ |
|:------:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
| $74    | 0  | 1  | 1  | 1  | 0  | 1  | 0  | 0  |

* ホークマンにイオ系/ヒャド系/ザキ系の攻撃を全て掛けた実績がある
	* メラ系/キラ系/バギ系の攻撃をどれも掛けた実績がない
* ホークマンが特技１（マホトーン）使った実績がある
	* 特技２（ホイミ）を使った実績がない

#### バグキャラ[$74]の所持品

フタバ竜の宝をミラーシールド（ドロップ率100%）にする例

|アドレス | No | 変更前         | ID  | 変更後         | ID  | 説明                   |
|:-------:|:--:|:---------------|:---:|:---------------|:---:|:-----------------------|
| $0adecc |  0 | （なし）       | $00 | ミラーシールド | $5d | フタバ竜：宝アイテムID |
|         |  1 | （なし）       | $00 | 薬草           | $62 | フタバ竜：ドロップ率   |
|         |  2 | （なし）       | $00 | （なし）       | $00 | 殺人エイ：名前アドレス |
|         |  3 | 棘の鞭         | $06 | 棘の鞭         | $06 |
|         |  4 | 光のドレス     | $40 | 光のドレス     | $40 |
|         |  5 | 不思議な木の実 | $6d | 不思議な木の実 | $6d |
|         |  6 | （なし）       | $00 | （なし）       | $00 | 殺人エイ：HP40         |
|         |  7 | 布の服         | $28 | 布の服         | $28 |
|         |  8 | （なし）       | $00 | （なし）       | $00 | 殺人エイ：攻撃力50     |
|         |  9 | 魔法の法衣     | $32 | 魔法の法衣     | $32 |

* フタバ竜はドロップアイテムのない魔物なので __PC隊列[255]__ にミラーシールドと薬草を順に渡すだけでいい
* 所持品変更の副作用で10バイト先の$0adecc[10]と$0adecc[11]が$00となり殺人エイの守備力が0になる

<video width="320" height="240" controls poster="https://gist.github.com/assets/22233327/7e95e0c8-8ff7-4b17-b9ea-12eceb5ca0a9"><source src="https://gist.github.com/assets/22233327/6d7c2a0c-9e1d-4e20-ae53-d923307f9ae5" type="video/mp4"></video>
<video width="320" height="240" controls poster="https://gist.github.com/assets/22233327/f73f55f4-c510-47c7-b3a2-c6dc405cfd62"><source src="https://gist.github.com/assets/22233327/64accbbf-853a-4038-9e56-3defaafa54cf" type="video/mp4"></video>

#### メモ

* ドロップアイテム化しているので何個でも手に入る
* リセットすると変更前に戻るのでリセット前にドロップさせないと変更に使ったアイテムを失ってしまう可能性がある
* 工夫すれば別の冒険の書にアイテムを渡すことも出来る
* 複数のセーブデータを併用すれば他の魔物の宝も変更できる
	* 例えば、魔物の宝箱を開けたとき持ち物が一杯でアイテムを捨てる方法を使って、
	おおみみず __（PC隊列[255]=$68）__ の宝を押し出しで入れ替えることが可能
	* ただしこの方法で変更できる種族は限られている

### 預かり所に任意のコードを格納（難易度★★★★★★★★★★★★）

* メモリ16MB超にアクセス可能な環境では何が起こるか未確認
	* 本体が壊れるかも
* フロッピーディスクイメージでの起動(TDQ2_A.XDF/TDQ2_B.XDF)以外ではアドレスが変わる
	* アドレスが変わる環境ではアドレス読み替えが必要で、その結果実現不可能になることもある
	* デバイスドライバの変更やハードディスクイメージへのインストールでもアドレスがズレる

#### ホークマン学習状態

施設進入サブルーチンの関数ポインタ配列的なアドレスにアクセス

* __PC隊列[255]__ を __バグキャラ[$cb]__ にセット

| データ | ホ | マ | ザ | ヒ | バ | イ | ギ | メ |
|:------:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
| $cb    | 1  | 1  | 0  | 0  | 1  | 0  | 1  | 1  |

* ホークマンにメラ系/ギラ系/バギ系の攻撃を全て掛けた実績がある
	* イオ系/ヒャド系/ザキ系の攻撃をどれも掛けた実績がない
* ホークマンが特技１（マホトーン）/特技２（ホイミ）を全て使った実績がある

#### バグキャラ[$cb]の所持品

__ヨラン進入サブルーチン__ のアドレス($06f21c)を預かり所でアクセス可能なアドレス($0aac8c)に変更する

|アドレス | No | 変更前     | ID  | 変更後       | ID  |
|:-------:|:--:|:-----------|:---:|:-------------|:---:|
| $0b0224 |  0 | （なし）   | $00 | 薬草         | $62 |
|         |  1 | 棘の鞭     | $06 | 毒蛾のナイフ | $0a |
|         |  2 | ぼー       | $f2 | アラキの法衣 | $ac |
|         |  3 | マグマの杖 | $1c | ラーの鏡     | $8c |
|         |  4 | （なし）   | $00 | （なし）     | $00 |
|         |  5 | 棘の鞭     | $06 | （なし）     | $00 |
|         |  6 | ぼー       | $f2 | （なし）     | $00 |
|         |  7 | 魔法の聖水 | $68 | （なし）     | $00 |
|         |  8 | （なし）   | $00 | （なし）     | $00 |
|         |  9 | くさり鎌   | $07 | （なし）     | $00 |

* __ぼー($f2)__ はバグアイテム
* 変更前の所持品が違う場合はアドレスがズレている環境なので実施してはいけない
* リセットすると変更前に戻るが、変更に使ったアイテムが消えてしまうので、用が済んだら所持品を取り返しておいた方が良い
	* 預かり所経由
* 実施中は下記の施設に入るとフリーズする（$0b0224から20バイト破壊しているため）
	* （預かり所コード完成前の）ヨラン
	* 封印の洞窟
	* コビアキムル
	* ガイコビア
	* イフットス
* __所持品[0]__ は薬草でなくても良い
	* アドレス上位1バイトは無視されるので下位3バイトが$0aac8cなら何でも良い
	* $00にすることができないので入手しやすい薬草とした
	* 実機やメモリ16MB超にアクセス可能な環境ではどうなるかわからない

#### 預かり所

例として、 __トーイ所持品[0]__ のアイテムIDを+2するコードを示す

* 預かり所は$0aac84から64バイト

|アドレス | No | アイテム         | ID  | 機械語   | ニーモニック     | コメント                                    |
|:-------:|:--:|:-----------------|:---:|:---------|:-----------------|:--------------------------------------------|
| $0aac84 |  0 | 薬草             | $62 | 6206f21c | .dc.l  $6206f21c | __ヨラン進入サブルーチン__ アドレス($06f21c) |
|         |  1 | 棘の鞭           | $06 |
|         |  2 | ぼー             | $f2 |
|         |  3 | マグマの杖       | $1c |
| $0aac88 |  4 | 薬草             | $62 | 6206b14c | .dc.l  $6206b14c | __トーイ所持品[0]__ アドレス($06b14c) |
|         |  5 | 毒蛾のナイフ     | $06 |
|         |  6 | タンボーの服     | $b1 |
|         |  7 | 幸福の帽子       | $4c |
| $0aac8c |  8 | おお木づち       | $22 | 2260     | movea.l -(a0),a1 | サブルーチン先頭                            |
|         |  9 | 星降る腕輪       | $60 |
|         | 10 | 皮の盾           | $54 | 5419     | addq.b  #2,(a1)+ | __トーイ所持品[0]__ のアイテムIDを+2      |
|         | 11 | イミルフのピアス | $19 |
|         | 12 | おお木づち       | $22 | 2260     | movea.l -(a0),a1 |
|         | 13 | 星降る腕輪       | $60 |
| $0aac92 | 14 | 不幸のかぶと     | $4e | 4e91     | jsr     (a1)     | __ヨラン進入サブルーチン__ を呼び出す       |
|         | 15 | ガス玉           | $91 |
|         | 16 | 不幸のかぶと     | $4e | 4e75     | rts              |
|         | 17 | ルラミトの雌石   | $75 |

* 最後に __ヨラン進入サブルーチン__ を呼び直しておかないとデータ不整合でフリーズする($0aac92)
* __預かり所[11]__ は __鍛えた後のカロシスの剣($18)__ で良いが、
__鍛える前のカロシスの剣($26)__ と紛らわしいので __イミルフのピアス($19)__ とした
* 呼び出し元でa0にサブルーチン先頭アドレス($620aac8c)を入れているので利用したが、たまたまこの例ではうまく動いているだけである

#### コード実行

上記の準備の下でヨランに入った時点で、 __トーイ所持品[0]__ のアイテムIDが+2される

TODO 古いメモなので記憶が曖昧。上記の内容で実際に出来るか念のため追試

#### メモ

トーイ所持品をコードの格納場所にする手もある

## 関連項目

* [バグ](bug.md)
	* [リッチのメガンテバグ](bug002.md)
	* [ノーセーブクリアバグ](bug003.md)
	* [バシルーラでキャラが消失する](bug004.md)
	* [預かり所のオーバーラン](bug001.md)
* [アイテム ID](item_id.md)
* [学習内容（セーブデータ）](ai_save.md)
* [魔物ステータス](https://drive.google.com/open?id=18jNK8kaJeE15HNrA6mdT89VcrGiCK6e4yhYCkNYLIgs)
